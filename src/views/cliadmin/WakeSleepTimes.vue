<template lang="html">
  <v-container fluid>
    <BaseViewHeader
      class="mx-2 mb-2"
      :headerIcon="headerIcon"
      :headerText="headerText"
      hasDivider
    >
      <BaseUserSelect
        v-if="level.find(role => role === 'CARER')"
        slot="rhViewHeaderColumn"
        :users="dashboardUsers"
        :selectedUser="selectedDashboardUser"
        @user-selected="$store.commit('SET_USER_CONTEXT', $event)"
      />
      <BaseUserSelect
        v-else
        slot="rhViewHeaderColumn"
        :users="cliAdminUsers"
        :selectedUser="cliAdminSelectedUser"
        @user-selected="$store.commit('SET_CLIADMIN_SELECTED_USER', $event)"
      />
    </BaseViewHeader>
    <v-menu
      ref="wakeUpTimePicker"
      v-model="showWakeUpTimePicker"
      :close-on-content-click="false"
      :nudge-right="60"
      :return-value="wakeUpTime"
      lazy
      transition="scale-transition"
      offset-y
      full-width
      max-width="290px"
      min-width="290px"
    >
      <template v-slot:activator="{ on }">
        <v-text-field
          class="mx-3"
          v-model="wakeUpTime"
          label="Wake up time"
          prepend-icon="brightness_5"
          readonly
          v-on="on"
          :rules="wakeUpTimeRules"
        />
      </template>
      <v-time-picker
        v-if="showWakeUpTimePicker"
        v-model="wakeUpTime"
        full-width
        @click:minute="$refs.wakeUpTimePicker.save(wakeUpTime)"
      />
    </v-menu>
    <v-menu
      ref="sleepTimePicker"
      v-model="showSleepTimePicker"
      :close-on-content-click="false"
      :nudge-right="40"
      :return-value="sleepTime"
      lazy
      transition="scale-transition"
      offset-y
      full-width
      max-width="290px"
      min-width="290px"
    >
      <template v-slot:activator="{ on }">
        <v-text-field
          class="mx-3"
          v-model="sleepTime"
          label="Sleep time"
          prepend-icon="brightness_3"
          readonly
          v-on="on"
          :rules="sleepTimeRules"
        />
      </template>
      <v-time-picker
        v-if="showSleepTimePicker"
        v-model="sleepTime"
        full-width
        @click:minute="$refs.sleepTimePicker.save(sleepTime)"
      />
    </v-menu>
    <v-layout row justify-center align-center>
      <v-fade-transition>
        <v-btn
          v-show="!isPristine"
          class="root-nav-btn"
          @click="save"
          color="primary"
          large
        >
          Save
          <v-icon class="ma-1">save</v-icon>
        </v-btn>
      </v-fade-transition>
      <v-fade-transition>
        <v-btn
          v-show="!isPristine"
          class="root-nav-btn"
          @click="reset"
          color="primary"
          large
        >
          Reset
          <v-icon class="ma-1">refresh</v-icon>
        </v-btn>
      </v-fade-transition>
    </v-layout>
  </v-container>
</template>

<script>

import BaseUserSelect from '@/components/base/BaseUserSelectComponent'
import { mapState } from 'vuex'

export default {
  name: 'WakeSleepTimes',
  components: { BaseUserSelect },
  computed: {
    ...mapState({
      cliAdminSelectedUser: state => state.cliAdminUsers.cliAdminSelectedUser,
      cliAdminUsers: state => state.cliAdminUsers.cliAdminUsers,
      selectedDashboardUser: state => state.dashboardUsers.selectedUser,
      dashboardUsers: state => state.dashboardUsers.dashboardUsers,
      level: state => state.eDropletApp.level
    }),
    isPristine () {
      return this.$store.getters.getterSleepWakeTimesIsPristine
    },
    defaultWakeUpTime () {
      return this.$store.getters.getterDefaultWakeUpTime
    },
    defaultSleepTime () {
      return this.$store.getters.getterDefaultSleepTime
    },
    wakeUpTime: {
      get () {
        return this.$store.getters.getterWakeUpTime
      },
      set (newValue) {
        this.$store.commit('UPDATE_WAKEUPTIME', newValue)
      }
    },
    sleepTime: {
      get () {
        return this.$store.getters.getterSleepTime
      },
      set (newValue) {
        this.$store.commit('UPDATE_SLEEPTIME', newValue)
      }
    }
  },
  data () {
    return {
      // BaseViewHeader
      headerIcon: 'local_drink',
      iconColor: this.$vuetify.theme.primary,
      headerText: 'Sleep and Wake up Times',
      // Wake up time pickers
      showWakeUpTimePicker: false,
      wakeUpTimeRules: [
        v => v !== null || 'Sleep time is required'
      ],
      // Sleep time pickers
      showSleepTimePicker: false,
      sleepTimeRules: [
        v => v !== null || 'Sleep time is required'
      ],
      // Render boolean
      timeValueChanged: false
    }
  },
  methods: {
    async save () {
      await this.$store.dispatch('updateCliAdminUser', this.cliAdminSelectedUser)
    },
    reset () {
      this.$store.commit('RESET_SLEEP_WAKE_TIMES')
    }
  },
  mounted () {
    this.$store.dispatch('fetchCliAdminUsers')
  },
  beforeRouteLeave (to, from, next) {
    if (!this.isPristine && !window.confirm('Do you really want to leave? You will lose all unsaved changes!')) {
      return next(false)
    }
    next()
  }

}
</script>

<style lang="scss" scoped>
@import "./public/scss/main.scss";
</style>
